stages:
- stage: Deploy
  condition: and (succeeded(), startsWith( variables['Build.SourceBranch'], 'refs/tags' ))
  dependsOn: Test
  jobs:
  - deployment: DeployArtifacts
    environment: Prod
    displayName: Deploys artifacts
    timeoutInMinutes: 10
    pool:
      vmImage: ubuntu-18.04
    cancelTimeoutInMinutes: 5
    strategy: 
      runOnce:
        deploy:
          steps:
          - checkout: none

          - download: current
            displayName: Download Nuget artifacts
            patterns: package/**/*
            artifact: binaries

          - script: >-
              dotnet nuget push
              -s https://apiint.nugettest.org/v3/index.json
              -k $(NUGET_TOKEN)
              ./package/*
            displayName: Push Nuget artifacts
            env:
              NUGET_TOKEN: $(nuget_org_push_new_versions)
