parameters:
- name: testProject
  type: string
  values:
  - UnitTests
  - IntegrationTests
- name: mayFailOn # Agent.OS: Linux, Windows_NT, Darwin
  type: string
  default: ''
- name: preTestSteps
  type: stepList
  default: []

steps:
- checkout: none

- ${{ parameters.preTestSteps }}

- task: DownloadPipelineArtifact@2
  displayName: Download ${{ parameters.testProject }} binaries
  inputs:
    targetpath: ./
    patterns: src/Tests/${{ parameters.testProject }}/**/*
    artifactname: binaries

- task: Powershell@2
  displayName: Set coverage collector
  inputs:
    targetType: inline
    script: |
      if ( -not ( "$(targetFrameworkMoniker)" -ilike "net4*" ) ) {
        echo "##vso[task.setvariable variable=collector;]XPlat Code Coverage"
      } else {
        # coverlet.collector does not support legacy net4.x
        echo "##vso[task.setvariable variable=collector;]"
      }

- task: CmdLine@2
  displayName: Restore ${{ parameters.testProject }}
  inputs:
    script: dotnet restore src/Tests/${{ parameters.testProject }}

# We cannot set continueOnError dynamically due to Azure Devops limitations
# As a workaround, we duplicate the tasks and use a condition to switch between a version w/ and w/o continueOnError
# https://developercommunityapi.westus.cloudapp.azure.com/idea/782159/yaml-pipeline-continueonerror-cant-accept-a-variab.html
- task: CmdLine@2
  displayName: Run ${{ parameters.testProject }}
  condition: and(succeeded(), ne('${{ parameters.mayFailOn }}', variables['Agent.OS']))
  inputs:
    script: >-
      dotnet test
      src/Tests/${{ parameters.testProject }}
      --configuration Release
      --no-build
      --framework $(targetFrameworkMoniker)
      --logger trx
      --results-directory ./results
      --collect:"$(collector)"

- task: CmdLine@2
  displayName: Run ${{ parameters.testProject }} (continue on error)
  condition: and(succeeded(), eq('${{ parameters.mayFailOn }}', variables['Agent.OS']))
  continueOnError: true
  inputs:
    script: >-
      dotnet test
      src/Tests/${{ parameters.testProject }}
      --configuration Release
      --no-build
      --framework $(targetFrameworkMoniker)
      --logger trx
      --results-directory ./results
      --collect:"$(collector)"

- task: PublishTestResults@2
  displayName: Publish ${{ parameters.testProject }} results
  condition: always()
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '**/*.trx'
    testRunTitle: ${{ parameters.testProject }} $(imageName) $(targetFrameworkMoniker)

- task: PublishPipelineArtifact@1
  condition: always()
  displayName: Publish ${{ parameters.testProject }} TRX files manually
  inputs:
    targetpath: ./results
    artifactname: ${{ parameters.testProject }}-results-$(imageName)-$(targetFrameworkMoniker)

- task: Bash@3
  displayName: Publish ${{ parameters.testProject }} coverage
  condition: always()
  continueOnError: true # TODO: Fix me
  inputs:
    targetType: inline
    script: |
      pwd
      cd src/Tests/${{ parameters.testProject }}/bin/Release/$(targetFrameworkMoniker)/
      pwd
      bash <(curl https://codecov.io/bash) -F ${{ parameters.testProject }} -F $(Agent.OS) -F $(targetFrameworkMoniker)
